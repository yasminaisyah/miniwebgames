<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Abyss Math: Deep Dive</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --water-top: #0288d1;
            --water-deep: #000051;
            --bubble: rgba(255, 255, 255, 0.3);
            --sub-body: #fbc02d;
            --sub-detail: #e65100;
            --good: #00e676;
            --bad: #ff1744;
            --ui-text: #81d4fa;
        }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, var(--water-top), var(--water-deep));
            height: 100vh;
            overflow: hidden;
            font-family: 'Roboto Mono', monospace;
            user-select: none;
            cursor: none; /* Hide default cursor for immersion */
            touch-action: none;
        }

        /* --- AMBIENCE --- */
        .bubble {
            position: absolute;
            background: var(--bubble);
            border-radius: 50%;
            pointer-events: none;
            animation: rise linear infinite;
        }

        @keyframes rise {
            from { transform: translateY(100vh) scale(0.5); opacity: 0; }
            to { transform: translateY(-10vh) scale(1.5); opacity: 0.6; }
        }

        .seaweed {
            position: absolute;
            bottom: -20px;
            width: 40px;
            background: #004d40;
            border-radius: 40px 40px 0 0;
            opacity: 0.8;
            transform-origin: bottom center;
            animation: sway 3s ease-in-out infinite;
            z-index: 1;
        }

        @keyframes sway {
            0%, 100% { transform: skewX(-5deg); }
            50% { transform: skewX(5deg); }
        }

        /* --- UI --- */
        #hud {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
            pointer-events: none;
        }

        .panel {
            background: rgba(0, 20, 40, 0.7);
            border: 2px solid #0277bd;
            color: var(--ui-text);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px #0277bd;
            backdrop-filter: blur(4px);
        }

        .target-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Black Ops One', cursive;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 0 10px #00e676;
            background: rgba(0,0,0,0.6);
            padding: 10px 30px;
            border-radius: 50px;
            border: 2px solid #00e676;
            z-index: 100;
        }

        #oxygen-bar {
            position: absolute;
            bottom: 20px; left: 20px; right: 20px;
            height: 25px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #546e7a;
            border-radius: 15px;
            overflow: hidden;
            z-index: 100;
        }

        #oxygen-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #00e676, #00b0ff);
            transition: width 0.2s linear;
        }

        /* --- GAME OBJECTS --- */
        #game-layer {
            position: absolute;
            width: 100%; height: 100%;
            z-index: 10;
        }

        /* The Submarine */
        #player-sub {
            position: absolute;
            width: 100px;
            height: 60px;
            left: 100px;
            top: 50%;
            transform: translate(-50%, -50%);
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
            transition: transform 0.1s;
        }

        /* Propeller Animation */
        .propeller {
            transform-origin: center;
            animation: spin 0.1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Obstacles (Orbs/Mines) */
        .obj {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            text-shadow: 0 2px 2px black;
        }

        .orb {
            width: 70px; height: 70px;
            background: radial-gradient(circle at 30% 30%, #a7ffeb, #00bfa5);
            border-radius: 50%;
            box-shadow: 0 0 15px #00bfa5;
            border: 2px solid #fff;
            animation: pulse 1s infinite alternate;
        }

        .mine {
            width: 60px; height: 60px;
            background: radial-gradient(circle at 30% 30%, #5d4037, #212121);
            border-radius: 50%;
            border: 2px solid #ff1744;
        }
        .mine::after {
            content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border: 4px dashed #ff1744; border-radius: 50%;
            animation: spin 4s linear infinite;
        }

        @keyframes pulse { from { box-shadow: 0 0 10px #00bfa5; } to { box-shadow: 0 0 25px #00bfa5; } }

        /* --- SCREENS --- */
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; color: white; text-align: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .screen.active { opacity: 1; pointer-events: auto; cursor: default; }

        h1 { font-family: 'Black Ops One', cursive; font-size: 4rem; color: #ffeb3b; margin: 0; letter-spacing: 5px; }
        .btn {
            margin-top: 30px; padding: 15px 40px; font-size: 1.5rem;
            background: #0288d1; border: none; color: white; border-radius: 5px;
            font-family: 'Black Ops One', cursive; cursor: pointer;
            box-shadow: 0 5px 0 #01579b; transition: transform 0.1s;
        }
        .btn:active { transform: translateY(5px); box-shadow: none; }

        .damage-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, rgba(255, 0, 0, 0.5));
            pointer-events: none; opacity: 0; z-index: 150;
            transition: opacity 0.1s;
        }

    </style>
</head>
<body>

    <div id="bubbles-container"></div>
    <div id="seaweed-container"></div>

    <div id="hud">
        <div class="panel">SCORE: <span id="score-val">0</span></div>
        <div class="panel">DEPTH: <span id="depth-val">100</span>m</div>
    </div>

    <div class="target-display">
        TARGET: <span id="target-num">?</span>
    </div>

    <div id="oxygen-bar"><div id="oxygen-fill"></div></div>
    <div class="damage-overlay" id="dmg-flash"></div>

    <div id="game-layer">
        <div id="player-sub">
            <svg viewBox="0 0 100 60">
                <path d="M5,20 L5,40 L15,30 Z" fill="#e65100" />
                <path d="M0,15 L0,45" stroke="#3e2723" stroke-width="4" class="propeller"/>
                <ellipse cx="55" cy="30" rx="40" ry="20" fill="#fbc02d" stroke="#e65100" stroke-width="2"/>
                <path d="M55,10 A 15 15 0 0 1 80 10" fill="none" stroke="#e65100" stroke-width="3" />
                <rect x="50" y="2" width="10" height="10" fill="#e65100"/>
                <circle cx="55" cy="0" r="4" fill="#81d4fa"/>
                <circle cx="70" cy="30" r="6" fill="#81d4fa" stroke="#37474f" stroke-width="2"/>
                <circle cx="50" cy="30" r="6" fill="#81d4fa" stroke="#37474f" stroke-width="2"/>
                <circle cx="30" cy="30" r="6" fill="#81d4fa" stroke="#37474f" stroke-width="2"/>
            </svg>
        </div>
    </div>

    <div id="start-screen" class="screen active">
        <h1>ABYSS MATH</h1>
        <p>Collect the bubbles that match the TARGET number.</p>
        <p>Avoid mines! Mouse/Touch to Move.</p>
        <button class="btn" onclick="startGame()">DIVE</button>
    </div>

    <div id="game-over-screen" class="screen">
        <h1 style="color: #ff1744">HULL BREACHED</h1>
        <p>Final Depth: <span id="final-score">0</span>m</p>
        <button class="btn" onclick="startGame()">RE-DIVE</button>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'sonar') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'collect') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(600, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- GAME VARIABLES ---
        let gameActive = false;
        let score = 0;
        let depth = 0;
        let oxygen = 100;
        let speed = 3;
        let spawnRate = 100; // frames
        let frameCount = 0;
        
        let targetNumber = 10;
        let objects = []; // { el: DOMElement, x: number, y: number, type: 'orb'|'mine', val: number }
        
        // Mouse/Sub Position
        let mouseX = 100;
        let mouseY = window.innerHeight / 2;
        let subY = window.innerHeight / 2;

        // --- MATH GENERATOR ---
        function generateTarget() {
            // New target number between 10 and 50
            targetNumber = Math.floor(Math.random() * 40) + 10;
            document.getElementById('target-num').innerText = targetNumber;
            
            // Play Sonar Sound
            playSound('sonar');
            
            // Change target visual pulse
            const disp = document.querySelector('.target-display');
            disp.style.transform = "translateX(-50%) scale(1.2)";
            setTimeout(() => disp.style.transform = "translateX(-50%) scale(1)", 200);
        }

        function createObject() {
            const isCorrect = Math.random() > 0.6; // 40% chance of correct orb
            const isMine = Math.random() > 0.8; // 20% chance of being a mine (wrong answer)
            
            let objType = 'orb';
            let mathStr = '';
            let val = 0;

            // Generate Math Problem
            if (isCorrect) {
                // Generate equation that equals target
                val = targetNumber;
                mathStr = makeEquation(targetNumber);
                objType = 'orb';
            } else {
                // Generate wrong equation
                let offset = Math.floor(Math.random() * 10) + 1;
                val = Math.random() > 0.5 ? targetNumber + offset : targetNumber - offset;
                mathStr = makeEquation(val);
                objType = isMine ? 'mine' : 'orb'; // Wrong answers can be mines or just dud orbs
                if(objType === 'mine') mathStr = ""; // Mines might just be obstacles or have numbers? Let's give them numbers too.
            }

            // Create Element
            const el = document.createElement('div');
            el.className = `obj ${objType}`;
            el.innerText = mathStr;
            el.style.top = Math.random() * (window.innerHeight - 100) + 50 + 'px';
            
            // Random Y drift
            el.dataset.yDrift = (Math.random() - 0.5) * 1; 

            document.getElementById('game-layer').appendChild(el);

            objects.push({
                el: el,
                x: window.innerWidth + 50,
                y: parseFloat(el.style.top),
                type: objType,
                correct: (val === targetNumber)
            });
        }

        function makeEquation(res) {
            let mode = Math.random();
            if (mode < 0.5) { // Addition
                let a = Math.floor(Math.random() * res);
                return `${a} + ${res - a}`;
            } else { // Subtraction
                let a = res + Math.floor(Math.random() * 10) + 1;
                return `${a} - ${a - res}`;
            }
        }

        // --- GAME LOOP ---
        function startGame() {
            gameActive = true;
            score = 0;
            depth = 0;
            oxygen = 100;
            speed = 3;
            objects.forEach(o => o.el.remove());
            objects = [];
            
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('game-over-screen').classList.remove('active');
            
            generateTarget();
            
            // Start input tracking
            window.addEventListener('mousemove', e => mouseY = e.clientY);
            window.addEventListener('touchmove', e => mouseY = e.touches[0].clientY, {passive: false});
            
            requestAnimationFrame(update);
        }

        function update() {
            if (!gameActive) return;

            frameCount++;
            depth += 0.1;
            oxygen -= 0.05;

            // Difficulty ramping
            if (frameCount % 600 === 0) {
                speed += 0.5;
                generateTarget(); // Change target every ~10 seconds
            }

            // Spawn Objects
            if (frameCount % Math.floor(120 / (speed/2)) === 0) {
                createObject();
            }

            // Move Submarine (Lerp for smooth physics)
            let dy = mouseY - subY;
            subY += dy * 0.05;
            
            // Rotate sub based on movement
            let rot = Math.min(Math.max(dy * 0.2, -20), 20);
            const subEl = document.getElementById('player-sub');
            subEl.style.top = subY + 'px';
            subEl.style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;

            // Update UI
            document.getElementById('score-val').innerText = score;
            document.getElementById('depth-val').innerText = Math.floor(depth);
            document.getElementById('oxygen-fill').style.width = Math.max(0, oxygen) + '%';
            
            if (oxygen < 30) document.getElementById('oxygen-fill').style.background = '#ff1744';
            else document.getElementById('oxygen-fill').style.background = 'linear-gradient(90deg, #00e676, #00b0ff)';

            // Move & Collide Objects
            for (let i = objects.length - 1; i >= 0; i--) {
                let obj = objects[i];
                obj.x -= speed;
                obj.y += parseFloat(obj.el.dataset.yDrift);
                obj.el.style.left = obj.x + 'px';
                obj.el.style.top = obj.y + 'px';

                // Collision Detection
                let dx = obj.x - 100; // 100 is sub X
                let dy_col = obj.y - subY;
                let dist = Math.sqrt(dx*dx + dy_col*dy_col);

                if (dist < 60) { // Hit
                    handleCollision(obj);
                    obj.el.remove();
                    objects.splice(i, 1);
                } else if (obj.x < -100) { // Off screen
                    obj.el.remove();
                    objects.splice(i, 1);
                }
            }

            if (oxygen <= 0) gameOver();
            else requestAnimationFrame(update);
        }

        function handleCollision(obj) {
            if (obj.correct && obj.type === 'orb') {
                // Good!
                playSound('collect');
                score += 10;
                oxygen = Math.min(100, oxygen + 15);
                // Visual pop
                createParticles(obj.x, obj.y, '#00e676');
            } else {
                // Bad!
                playSound('hit');
                oxygen -= 20;
                // Screen Flash
                const flash = document.getElementById('dmg-flash');
                flash.style.opacity = 1;
                setTimeout(() => flash.style.opacity = 0, 100);
                createParticles(obj.x, obj.y, '#ff1744');
            }
        }

        function createParticles(x, y, color) {
            for(let i=0; i<5; i++) {
                let p = document.createElement('div');
                p.style.position = 'absolute';
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.width = '10px'; p.style.height = '10px';
                p.style.background = color;
                p.style.borderRadius = '50%';
                document.getElementById('game-layer').appendChild(p);
                
                let angle = Math.random() * Math.PI * 2;
                let vel = Math.random() * 50 + 20;
                
                p.animate([
                    { transform: 'translate(0,0) scale(1)', opacity: 1 },
                    { transform: `translate(${Math.cos(angle)*vel}px, ${Math.sin(angle)*vel}px) scale(0)`, opacity: 0 }
                ], { duration: 500, fill: 'forwards' }).onfinish = () => p.remove();
            }
        }

        function gameOver() {
            gameActive = false;
            document.getElementById('final-score').innerText = Math.floor(depth);
            document.getElementById('game-over-screen').classList.add('active');
        }

        // --- AMBIENCE GENERATION ---
        function initBg() {
            // Bubbles
            for(let i=0; i<20; i++) {
                let b = document.createElement('div');
                b.className = 'bubble';
                b.style.left = Math.random() * 100 + '%';
                b.style.width = Math.random() * 20 + 5 + 'px';
                b.style.height = b.style.width;
                b.style.animationDuration = Math.random() * 5 + 5 + 's';
                b.style.animationDelay = Math.random() * -10 + 's';
                document.getElementById('bubbles-container').appendChild(b);
            }
            // Seaweed
            for(let i=0; i<15; i++) {
                let s = document.createElement('div');
                s.className = 'seaweed';
                s.style.left = (i * 7) + '%';
                s.style.height = Math.random() * 100 + 50 + 'px';
                s.style.animationDelay = Math.random() * -2 + 's';
                document.getElementById('seaweed-container').appendChild(s);
            }
        }
        initBg();

    </script>
</body>
</html>