<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber Serpent: Math Eater</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #0d0d0d;
            font-family: 'Press Start 2P', cursive;
            color: #00ff41;
            touch-action: none;
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* CRT Scanline Effect */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 10;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        canvas {
            background: #111;
            box-shadow: 0 0 20px #00ff41;
            border: 2px solid #00ff41;
            margin-top: 10px;
            image-rendering: pixelated;
        }

        #hud {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            box-sizing: border-box;
            z-index: 20;
        }

        #equation-display {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            font-size: 1.5rem;
            z-index: 5;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
        }

        /* CONTROLS (Mobile) */
        #d-pad {
            display: none; /* Hidden on desktop by default, shown via JS if touch */
            position: absolute;
            bottom: 20px;
            width: 180px;
            height: 180px;
            z-index: 30;
        }

        .pad-btn {
            position: absolute;
            width: 60px; height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #00ff41;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: #00ff41;
            cursor: pointer;
        }
        .pad-btn:active { background: rgba(0, 255, 65, 0.3); }

        #btn-up { top: 0; left: 60px; }
        #btn-down { bottom: 0; left: 60px; }
        #btn-left { top: 60px; left: 0; }
        #btn-right { top: 60px; right: 0; }

        /* SCREENS */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100;
            text-align: center;
        }
        .hidden { display: none; }

        h1 { color: #00ff41; text-shadow: 4px 4px 0 #003300; line-height: 1.5; font-size: 2rem; }
        p { color: #ccc; font-size: 0.8rem; margin-bottom: 30px; line-height: 1.5; }

        button.main-btn {
            background: #00ff41;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 0 10px #00ff41;
        }
        button.main-btn:hover { background: #fff; }

        @media (max-width: 800px) {
            #d-pad { display: block; }
        }
    </style>
</head>
<body>

    <div id="hud">
        <div>SCORE: <span id="score">0</span></div>
        <div>HIGHSCORE: <span id="highscore">0</span></div>
    </div>

    <div id="equation-display">READY</div>

    <canvas id="gameCanvas"></canvas>

    <div id="d-pad">
        <div class="pad-btn" id="btn-up">▲</div>
        <div class="pad-btn" id="btn-left">◀</div>
        <div class="pad-btn" id="btn-right">▶</div>
        <div class="pad-btn" id="btn-down">▼</div>
    </div>

    <div id="start-screen" class="modal">
        <h1>CYBER<br>SERPENT</h1>
        <p>EAT THE CORRECT ANSWER.<br>WRONG NUMBERS = POISON.</p>
        <button class="main-btn" onclick="startGame()">INITIALIZE</button>
    </div>

    <div id="game-over-screen" class="modal hidden">
        <h1 style="color: #ff0055">SYSTEM<br>FAILURE</h1>
        <p>SCORE: <span id="final-score">0</span></p>
        <button class="main-btn" onclick="startGame()">REBOOT</button>
    </div>

    <script>
        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if(type === 'eat') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.setValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'crash') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(20, now + 0.3);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'move') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(200, now);
                gain.gain.setValueAtTime(0.02, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            }
        }

        // --- SETUP ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Grid System
        const gridSize = 20;
        let tileCountX = 20;
        let tileCountY = 20;
        
        function resize() {
            // Fit to screen but keep aspect ratio roughly or just box it
            let size = Math.min(window.innerWidth - 20, window.innerHeight - 200);
            size = Math.floor(size / gridSize) * gridSize; // Snap to grid
            canvas.width = size;
            canvas.height = size;
            tileCountX = size / gridSize;
            tileCountY = size / gridSize;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- GAME STATE ---
        let snake = [];
        let apples = [];
        let velocity = { x: 0, y: 0 };
        let nextVelocity = { x: 0, y: 0 }; // Buffer input
        let score = 0;
        let highscore = 0;
        let gameInterval;
        let speed = 150; // ms per frame
        let currentQ = { txt: "", ans: 0 };
        let isGameRunning = false;

        // --- LOGIC ---
        function generateMath() {
            let lvl = Math.floor(score / 30);
            let a = Math.floor(Math.random() * (10 + lvl * 5));
            let b = Math.floor(Math.random() * (10 + lvl * 5));
            let op = Math.random();
            let ans = 0;
            let symbol = "+";

            if (lvl > 2 && op > 0.7) {
                // Multiplication (Simple)
                a = Math.floor(Math.random() * 5) + 2;
                b = Math.floor(Math.random() * 5) + 2;
                ans = a * b;
                symbol = "×";
            } else if (op > 0.5) {
                // Subtraction
                if (b > a) [a, b] = [b, a]; // Swap to keep positive
                ans = a - b;
                symbol = "-";
            } else {
                ans = a + b;
            }

            currentQ = { txt: `${a} ${symbol} ${b}`, ans: ans };
            document.getElementById('equation-display').innerText = currentQ.txt + " = ?";
            spawnApples(ans);
        }

        function spawnApples(correctVal) {
            apples = [];
            // Spawn 1 Correct
            apples.push({ x: getRandomPos(), y: getRandomPos(), val: correctVal, correct: true });
            
            // Spawn 2 Wrongs
            for(let i=0; i<2; i++) {
                let w = correctVal + Math.floor(Math.random() * 10) - 5;
                if(w === correctVal) w += 1;
                apples.push({ x: getRandomPos(), y: getRandomPos(), val: w, correct: false });
            }
        }

        function getRandomPos() {
            return Math.floor(Math.random() * tileCountX);
        }

        function startGame() {
            score = 0;
            document.getElementById('score').innerText = score;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            
            // Init Snake
            snake = [
                { x: 10, y: 10 },
                { x: 9, y: 10 },
                { x: 8, y: 10 }
            ];
            velocity = { x: 1, y: 0 };
            nextVelocity = { x: 1, y: 0 };
            
            generateMath();
            isGameRunning = true;
            if(gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, speed);
        }

        function gameLoop() {
            // Apply Velocity
            velocity = nextVelocity;
            let head = { x: snake[0].x + velocity.x, y: snake[0].y + velocity.y };

            // Wall Collision (Wrap or Die? Let's Die for "Cyber" difficulty)
            if (head.x < 0 || head.x >= tileCountX || head.y < 0 || head.y >= tileCountY) {
                gameOver();
                return;
            }

            // Self Collision
            for(let i=0; i<snake.length; i++) {
                if(head.x === snake[i].x && head.y === snake[i].y) {
                    gameOver();
                    return;
                }
            }

            // Apple Collision
            let ate = false;
            for(let i=0; i<apples.length; i++) {
                if(head.x === apples[i].x && head.y === apples[i].y) {
                    if(apples[i].correct) {
                        // Correct!
                        score += 10;
                        document.getElementById('score').innerText = score;
                        playTone('eat');
                        generateMath();
                        ate = true;
                        
                        // Speed up slightly
                        if(speed > 80) {
                            speed -= 2;
                            clearInterval(gameInterval);
                            gameInterval = setInterval(gameLoop, speed);
                        }
                    } else {
                        // Wrong!
                        gameOver();
                        return;
                    }
                    break;
                }
            }

            // Move Snake
            snake.unshift(head);
            if(!ate) {
                snake.pop();
            }

            draw();
        }

        function draw() {
            // Clear
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw Grid (Subtle)
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 1;
            /* // Too visually noisy for gameplay, disabled grid lines
            for(let i=0; i<tileCountX; i++) {
                ctx.beginPath(); ctx.moveTo(i*gridSize, 0); ctx.lineTo(i*gridSize, canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, i*gridSize); ctx.lineTo(canvas.width, i*gridSize); ctx.stroke();
            }
            */

            // Draw Snake
            ctx.fillStyle = '#00ff41';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00ff41';
            snake.forEach((part, index) => {
                // Head is brighter
                if(index === 0) ctx.fillStyle = '#ccffcc';
                else ctx.fillStyle = '#00ff41';
                
                ctx.fillRect(part.x * gridSize + 1, part.y * gridSize + 1, gridSize - 2, gridSize - 2);
            });
            ctx.shadowBlur = 0;

            // Draw Apples
            apples.forEach(a => {
                // Draw Box
                ctx.fillStyle = a.correct ? '#ffff00' : '#ff0055'; // Yellow for correct? No, let's hide visual cues.
                // Actually, to make it fair, they should look distinct only by number.
                // But user wants "Apple". Let's use Red Squares with Numbers.
                ctx.fillStyle = '#ff3333';
                ctx.fillRect(a.x * gridSize + 1, a.y * gridSize + 1, gridSize - 2, gridSize - 2);

                // Draw Text
                ctx.fillStyle = '#fff';
                ctx.font = "10px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(a.val, a.x * gridSize + gridSize/2, a.y * gridSize + gridSize/2);
            });
        }

        function gameOver() {
            isGameRunning = false;
            clearInterval(gameInterval);
            playTone('crash');
            
            if(score > highscore) highscore = score;
            document.getElementById('highscore').innerText = highscore;
            document.getElementById('final-score').innerText = score;
            
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

        // --- CONTROLS ---
        document.addEventListener('keydown', e => {
            if(!isGameRunning) return;
            switch(e.key) {
                case 'ArrowUp': if(velocity.y !== 1) nextVelocity = {x: 0, y: -1}; break;
                case 'ArrowDown': if(velocity.y !== -1) nextVelocity = {x: 0, y: 1}; break;
                case 'ArrowLeft': if(velocity.x !== 1) nextVelocity = {x: -1, y: 0}; break;
                case 'ArrowRight': if(velocity.x !== -1) nextVelocity = {x: 1, y: 0}; break;
            }
        });

        // Touch Controls
        document.getElementById('btn-up').addEventListener('touchstart', (e) => { e.preventDefault(); if(velocity.y !== 1) nextVelocity = {x: 0, y: -1}; });
        document.getElementById('btn-down').addEventListener('touchstart', (e) => { e.preventDefault(); if(velocity.y !== -1) nextVelocity = {x: 0, y: 1}; });
        document.getElementById('btn-left').addEventListener('touchstart', (e) => { e.preventDefault(); if(velocity.x !== 1) nextVelocity = {x: -1, y: 0}; });
        document.getElementById('btn-right').addEventListener('touchstart', (e) => { e.preventDefault(); if(velocity.x !== -1) nextVelocity = {x: 1, y: 0}; });

        // Mouse clicks on buttons for testing on desktop
        document.getElementById('btn-up').addEventListener('mousedown', () => { if(velocity.y !== 1) nextVelocity = {x: 0, y: -1}; });
        document.getElementById('btn-down').addEventListener('mousedown', () => { if(velocity.y !== -1) nextVelocity = {x: 0, y: 1}; });
        document.getElementById('btn-left').addEventListener('mousedown', () => { if(velocity.x !== 1) nextVelocity = {x: -1, y: 0}; });
        document.getElementById('btn-right').addEventListener('mousedown', () => { if(velocity.x !== -1) nextVelocity = {x: 1, y: 0}; });

    </script>
</body>
</html>