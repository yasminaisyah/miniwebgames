<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraction Workbook</title>
    <style>
        :root {
            --paper-color: #fdfbf7;
            --line-color: #a2d5f2;
            --ink-color: #2c3e50;
            --pencil-gray: #95a5a6;
            --red-mark: #e74c3c;
            --green-mark: #27ae60;
            --blue-pen: #2980b9;
        }

        * {
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Segoe UI', sans-serif; /* Handwriting feel */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--ink-color);
            font-size: 18px;
        }

        /* Notebook Paper Effect */
        .notebook-page {
            width: 100%;
            max-width: 600px;
            min-height: 80vh;
            background-color: var(--paper-color);
            background-image: 
                linear-gradient(var(--line-color) 1px, transparent 1px);
            background-size: 100% 2rem;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
            padding: 40px;
            position: relative;
            border-left: 2px solid #ffcccc; /* Red margin line */
            margin: 20px;
            display: flex;
            flex-direction: column;
        }

        /* Holes in paper */
        .notebook-page::before {
            content: '';
            position: absolute;
            top: 0; left: 10px; height: 100%; width: 20px;
            background-image: radial-gradient(#e0e0e0 20%, transparent 20%);
            background-size: 100% 4rem;
            background-position: 0 2rem;
        }

        h1 {
            text-align: center;
            color: var(--ink-color);
            font-size: 2.5rem;
            margin-top: 0;
            margin-bottom: 1rem;
            border-bottom: 3px double var(--ink-color);
            padding-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--pencil-gray);
            font-style: italic;
            margin-bottom: 2rem;
        }

        /* Navigation / Menu */
        .menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-item {
            background: white;
            border: 1px solid var(--line-color);
            margin-bottom: 15px;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
            font-size: 1.2rem;
        }

        .menu-item:hover {
            transform: translateX(5px);
            border-left: 5px solid var(--blue-pen);
        }

        .menu-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }

        /* Game Screen */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        .top-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            font-weight: bold;
            color: var(--pencil-gray);
            border-bottom: 2px solid var(--line-color);
            padding-bottom: 10px;
        }

        .problem-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            min-height: 150px;
        }

        /* Fraction Styling */
        .math-expression {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 3rem;
            font-family: 'Courier New', monospace; /* Typewriter/Print look */
        }

        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 5px;
            font-size: 0.8em;
            vertical-align: middle;
        }

        .frac-num {
            border-bottom: 2px solid currentColor;
            padding: 0 5px;
            text-align: center;
        }

        .frac-den {
            text-align: center;
        }

        .mixed-whole {
            font-size: 1.2em;
            margin-right: 8px;
        }

        .label-text {
            font-size: 1rem;
            color: var(--blue-pen);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            border: 1px solid var(--blue-pen);
            padding: 5px 15px;
            border-radius: 15px;
            background: #fff;
        }

        /* Answer Grid */
        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .answer-card {
            background: white;
            border: 1px dashed var(--pencil-gray);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .answer-card:hover {
            border-style: solid;
            border-color: var(--blue-pen);
            background: #f0f8ff;
        }

        /* Interaction States */
        .answer-card.correct {
            border: 2px solid var(--green-mark);
            background-color: #e8f8f5;
            color: var(--green-mark);
            position: relative;
        }

        .answer-card.correct::after {
            content: '‚úì';
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--green-mark);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .answer-card.wrong {
            opacity: 0.5;
            border-color: #ddd;
            background: #f5f5f5;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .feedback-text {
            height: 30px;
            text-align: center;
            font-weight: bold;
            color: var(--blue-pen);
            margin-top: 10px;
        }

        /* Result Screen */
        .report-card {
            border: 4px double var(--ink-color);
            padding: 30px;
            margin: 20px 0;
            background: #fff;
            transform: rotate(-1deg);
            box-shadow: 3px 3px 10px rgba(0,0,0,0.1);
        }

        .grade-stamp {
            font-size: 4rem;
            color: var(--red-mark);
            font-weight: bold;
            border: 5px solid var(--red-mark);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 20px auto;
            transform: rotate(-15deg);
            opacity: 0.8;
        }

        .btn-main {
            background: var(--ink-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            border-radius: 5px;
            width: 100%;
            margin-top: auto;
            transition: background 0.2s;
        }

        .btn-main:hover {
            background: var(--blue-pen);
        }

        /* Added Audio Button Style */
        .audio-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: 2px solid var(--pencil-gray);
            color: var(--pencil-gray);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 100;
        }
        .audio-toggle:hover {
            border-color: var(--blue-pen);
            color: var(--blue-pen);
            background: rgba(255,255,255,0.5);
        }

    </style>
</head>
<body>

    <div class="notebook-page">
        <button class="audio-toggle" id="audio-btn" onclick="toggleAudio()">üîä</button>
        
        <!-- HOME SCREEN -->
        <div id="screen-home" class="screen active">
            <h1>Fraction Workbook</h1>
            <p class="subtitle">Select a topic to begin your practice session.</p>
            
            <ul class="menu-list">
                <li class="menu-item" onclick="startSession('convert')">
                    <span class="menu-icon">1Ô∏è‚É£</span> Mixed & Improper Numbers
                </li>
                <li class="menu-item" onclick="startSession('add')">
                    <span class="menu-icon">‚ûï</span> Adding Fractions
                </li>
                <li class="menu-item" onclick="startSession('sub')">
                    <span class="menu-icon">‚ûñ</span> Subtracting Fractions
                </li>
                <li class="menu-item" onclick="startSession('mix')">
                    <span class="menu-icon">üìù</span> Review All Topics
                </li>
            </ul>
        </div>

        <!-- PRACTICE SCREEN -->
        <div id="screen-practice" class="screen">
            <div class="top-bar">
                <span id="topic-title">Practice</span>
                <span>Problem <span id="q-current">1</span> / <span id="q-total">10</span></span>
            </div>

            <div class="problem-area">
                <div class="label-text" id="q-instruction">Calculate</div>
                <div class="math-expression" id="expression-display">
                    <!-- Content injected via JS -->
                </div>
            </div>

            <div class="answers-grid" id="options-container">
                <!-- Options injected via JS -->
            </div>

            <div class="feedback-text" id="feedback"></div>
        </div>

        <!-- REPORT SCREEN -->
        <div id="screen-report" class="screen">
            <h1>Session Report</h1>
            
            <div class="report-card">
                <div class="grade-stamp" id="final-grade">A</div>
                <div style="text-align: center;">
                    <p><strong>Correct on First Try:</strong> <span id="stat-first-try">0</span></p>
                    <p><strong>Total Problems:</strong> 10</p>
                    <p id="teacher-comment" style="font-style: italic; margin-top: 20px; color: var(--blue-pen);">Excellent work!</p>
                </div>
            </div>

            <button class="btn-main" onclick="goHome()">Return to Index</button>
        </div>

    </div>

    <script>
        // --- AUDIO ENGINE (Gentle Workbook Sounds) ---
        const AudioSys = {
            ctx: null,
            on: true,
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
            },
            playTone(freq, type, dur, start = 0, vol = 0.1) {
                if (!this.on || !this.ctx) return;
                const t = this.ctx.currentTime + start;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.start(t);
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(vol, t + 0.02); // Soft attack
                gain.gain.exponentialRampToValueAtTime(0.001, t + dur); // Soft release
                osc.stop(t + dur + 0.1);
            },
            click() { this.playTone(800, 'sine', 0.05, 0, 0.05); },
            correct() { 
                // Soft major chord
                this.playTone(523.25, 'sine', 0.3, 0, 0.1); // C5
                this.playTone(659.25, 'sine', 0.3, 0.1, 0.1); // E5
            },
            wrong() { this.playTone(150, 'triangle', 0.2, 0, 0.05); }, // Soft low thud
            win() {
                [523, 659, 783, 1046].forEach((f, i) => this.playTone(f, 'sine', 0.4, i * 0.1, 0.1));
            }
        };

        function toggleAudio() {
            AudioSys.on = !AudioSys.on;
            document.getElementById('audio-btn').textContent = AudioSys.on ? 'üîä' : 'üîá';
            if(AudioSys.on) AudioSys.init();
        }

        // --- MATH LOGIC (Reuse of solid logic) ---
        const GCD = (a, b) => b === 0 ? a : GCD(b, a % b);
        const LCM = (a, b) => (a * b) / GCD(a, b);

        class Fraction {
            constructor(n, d, w = 0) { this.n = n; this.d = d; this.w = w; }
            
            toImproper() {
                if (this.w === 0) return new Fraction(this.n, this.d);
                return new Fraction(this.w * this.d + this.n, this.d);
            }

            toMixed() {
                if (this.n < this.d) return new Fraction(this.n, this.d, 0);
                const whole = Math.floor(this.n / this.d);
                const rem = this.n % this.d;
                return new Fraction(rem, this.d, whole);
            }

            simplify() {
                let common = GCD(this.n, this.d);
                return new Fraction(this.n / common, this.d / common, this.w);
            }

            // HTML for "Workbook" style (cleaner, black text)
            toHTML() {
                if (this.n === 0 && this.w !== 0) return `<span class="mixed-whole">${this.w}</span>`;
                if (this.d === 1) return `<span class="mixed-whole">${this.w + this.n}</span>`;
                if (this.n === 0 && this.w === 0) return `<span class="mixed-whole">0</span>`;

                let html = '';
                if (this.w > 0) html += `<span class="mixed-whole">${this.w}</span>`;
                if (this.n > 0) {
                    html += `<div class="fraction">
                        <span class="frac-num">${this.n}</span>
                        <span class="frac-den">${this.d}</span>
                    </div>`;
                }
                return html;
            }

            equals(other) {
                const a = this.toImproper();
                const b = other.toImproper();
                return a.n === b.n && a.d === b.d;
            }

            add(other) {
                const a = this.toImproper();
                const b = other.toImproper();
                const commonD = LCM(a.d, b.d);
                const newN = (a.n * (commonD / a.d)) + (b.n * (commonD / b.d));
                return new Fraction(newN, commonD).simplify();
            }

            sub(other) {
                const a = this.toImproper();
                const b = other.toImproper();
                const commonD = LCM(a.d, b.d);
                let newN = (a.n * (commonD / a.d)) - (b.n * (commonD / b.d));
                if(newN < 0) newN = 0;
                return new Fraction(newN, commonD).simplify();
            }
        }

        // --- APP STATE ---
        const state = {
            mode: 'mix',
            qIndex: 0,
            totalQ: 10,
            correctFirstTry: 0,
            currentAnswer: null,
            firstAttempt: true,
            locked: false,
            history: new Set() // Added for No Repeats
        };

        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startSession(mode) {
            AudioSys.init();
            AudioSys.click();
            state.mode = mode;
            state.qIndex = 0;
            state.correctFirstTry = 0;
            state.totalQ = 10;
            state.history.clear(); // Clear history on new start
            switchScreen('screen-practice');
            nextQuestion();
        }

        function nextQuestion() {
            if (state.qIndex >= state.totalQ) {
                showReport();
                return;
            }

            state.qIndex++;
            state.firstAttempt = true;
            state.locked = false;
            
            // UI Reset
            document.getElementById('q-current').textContent = state.qIndex;
            document.getElementById('feedback').textContent = '';

            // Generate Unique Question
            let type = state.mode;
            if (type === 'mix') {
                // Simple weighted random for mix
                const r = Math.random();
                if (r < 0.3) type = 'convert';
                else if (r < 0.65) type = 'add';
                else type = 'sub';
            }
            
            // Update Header
            const titles = { 'convert': 'Conversions', 'add': 'Addition', 'sub': 'Subtraction', 'mix': 'Mixed Review' };
            document.getElementById('topic-title').textContent = titles[state.mode === 'mix' ? 'mix' : type] || 'Practice'; // Keep main title stable or change per Q? Let's keep dynamic based on Q type for clarity or Mode? Let's use Mode name for consistency, or specific topic. Let's use specific topic for clarity.
            document.getElementById('topic-title').textContent = titles[state.mode] || 'Practice';


            generateUniqueQuestionData(type);
        }

        function generateUniqueQuestionData(type) {
            let attempts = 0;
            let unique = false;
            
            while (!unique && attempts < 50) {
                // Generate potential question
                const qData = createQuestionLogic(type);
                
                // Create a unique signature for this question
                // e.g. "add:1/2+1/4"
                const sig = `${type}:${qData.sig}`;
                
                if (!state.history.has(sig)) {
                    state.history.add(sig);
                    renderQuestion(qData);
                    unique = true;
                }
                attempts++;
            }
            
            // Fallback if we somehow run out (unlikely with randoms)
            if (!unique) renderQuestion(createQuestionLogic(type));
        }

        function createQuestionLogic(type) {
            const getDenom = () => [2, 3, 4, 5, 6, 8, 10, 12][rand(0, 7)];
            let displayHtml = '';
            let instruction = '';
            let correct = null;
            let signature = '';

            if (type === 'convert') {
                const isMixedToImp = rand(0, 1);
                const d = getDenom();
                const w = rand(1, 4);
                const n = rand(1, d - 1);
                const mixed = new Fraction(n, d, w);
                const improper = mixed.toImproper();

                signature = `conv-${isMixedToImp}-${w}-${n}-${d}`;

                if (isMixedToImp) {
                    instruction = "Rewrite as Improper Fraction";
                    displayHtml = mixed.toHTML() + ` = ?`;
                    correct = improper;
                } else {
                    instruction = "Rewrite as Mixed Number";
                    displayHtml = improper.toHTML() + ` = ?`;
                    correct = mixed;
                }
            } else {
                const d1 = getDenom();
                const d2 = rand(0,1) ? d1 : getDenom(); 
                
                let f1 = new Fraction(rand(1, d1*2), d1);
                let f2 = new Fraction(rand(1, d2), d2);

                // Swap for subtraction
                if (type === 'sub') {
                    if ((f1.toImproper().n / f1.d) < (f2.toImproper().n / f2.d)) {
                        [f1, f2] = [f2, f1];
                    }
                }
                
                // Basic signature based on values
                signature = `${type}-${f1.n}/${f1.d}/${f1.w}-${f2.n}/${f2.d}/${f2.w}`;

                correct = type === 'add' ? f1.add(f2) : f1.sub(f2);
                if (correct.n >= correct.d) correct = correct.toMixed(); 

                instruction = type === 'add' ? "Add the fractions" : "Subtract the fractions";
                const op = type === 'add' ? '+' : '‚àí';
                displayHtml = `${f1.toMixed().toHTML()} ${op} ${f2.toMixed().toHTML()} = ?`;
            }

            return { html: displayHtml, instruct: instruction, ans: correct, sig: signature };
        }

        function renderQuestion(data) {
            state.currentAnswer = data.ans;
            document.getElementById('q-instruction').textContent = data.instruct;
            document.getElementById('expression-display').innerHTML = data.html;
            generateOptions(data.ans);
        }

        function generateOptions(correct) {
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            // Generate Distractors
            let opts = [correct];
            const cImp = correct.toImproper();

            opts.push(new Fraction(rand(1, 10), rand(2, 12)).toMixed()); 
            opts.push(new Fraction(Math.max(1, cImp.n + 1), cImp.d).toMixed());
            opts.push(new Fraction(rand(1, 10), rand(2, 8)).toMixed());

            // Filter duplicates in options
            let uniqueOpts = [];
            const seen = new Set();
            for (let o of opts) {
                // Simple hash for option uniqueness
                const hash = `${o.n}/${o.d}/${o.w}`;
                if(!seen.has(hash)) {
                    seen.add(hash);
                    uniqueOpts.push(o);
                }
            }
            // Fill if duplicates removed
            while(uniqueOpts.length < 4) {
                 uniqueOpts.push(new Fraction(rand(1,10), rand(2,5)).toMixed());
            }

            // Shuffle
            uniqueOpts = uniqueOpts.slice(0, 4).sort(() => Math.random() - 0.5);
            
            // Render
            uniqueOpts.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'answer-card';
                div.innerHTML = opt.toHTML();
                div.onclick = () => handleInput(opt, div);
                container.appendChild(div);
            });
        }

        function handleInput(selected, element) {
            if (state.locked || element.classList.contains('wrong')) return;

            const feedback = document.getElementById('feedback');

            if (selected.equals(state.currentAnswer)) {
                // Correct
                state.locked = true;
                element.classList.add('correct');
                feedback.style.color = 'var(--green-mark)';
                feedback.textContent = state.firstAttempt ? "Excellent!" : "Correct!";
                AudioSys.correct();
                
                if (state.firstAttempt) state.correctFirstTry++;

                setTimeout(nextQuestion, 1500);
            } else {
                // Wrong
                state.firstAttempt = false;
                element.classList.add('wrong');
                feedback.style.color = 'var(--red-mark)';
                feedback.textContent = "Try again.";
                AudioSys.wrong();
            }
        }

        function showReport() {
            AudioSys.win();
            switchScreen('screen-report');
            const score = state.correctFirstTry;
            document.getElementById('stat-first-try').textContent = score;

            let grade = 'C';
            let comment = "Keep practicing!";
            
            if (score >= 9) { grade = 'A+'; comment = "Outstanding performance!"; }
            else if (score >= 8) { grade = 'A'; comment = "Great job!"; }
            else if (score >= 6) { grade = 'B'; comment = "Good effort!"; }
            
            document.getElementById('final-grade').textContent = grade;
            document.getElementById('teacher-comment').textContent = comment;
        }

        function goHome() {
            AudioSys.click();
            switchScreen('screen-home');
        }

    </script>
</body>
</html>