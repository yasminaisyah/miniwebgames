<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Clockwork Keeper</title>
    <style>
        :root {
            --brass: #b5a642;
            --bronze: #cd7f32;
            --copper: #b87333;
            --iron: #2c3e50;
            --steam: #ecf0f1;
            --danger: #c0392b;
            --bg-dark: #1a1a1d;
            --glass: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: var(--brass);
            overflow-x: hidden;
            padding: 20px 0;
        }

        /* Rotating Gear Background */
        .gear-bg {
            position: fixed;
            top: 50%; left: 50%;
            width: 80vw; height: 80vw;
            max-width: 600px; max-height: 600px;
            background: radial-gradient(circle, transparent 60%, var(--iron) 61%),
                        conic-gradient(from 0deg, transparent 0deg 10deg, var(--iron) 10deg 20deg) repeat;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.1;
            z-index: -1;
            animation: spin 60s linear infinite;
            border: 20px dashed var(--iron);
        }

        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        .game-frame {
            width: 100%;
            max-width: 600px;
            border: 8px solid var(--bronze);
            border-radius: 20px;
            background: #0f0f0f;
            box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 0 50px rgba(0,0,0,0.8);
            padding: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 10px;
        }

        /* Screws on corners */
        .game-frame::after, .game-frame::before {
            content: "+";
            position: absolute;
            font-size: 2rem;
            color: var(--copper);
            font-weight: bold;
        }
        .game-frame::before { top: 5px; left: 10px; text-shadow: 550px 0 0 var(--copper); }
        .game-frame::after { bottom: 5px; left: 10px; text-shadow: 550px 0 0 var(--copper); }

        /* Pressure Gauge Header */
        .gauge-panel {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--iron);
            padding-bottom: 15px;
        }

        .pressure-meter {
            width: 150px;
            height: 20px;
            background: #333;
            border: 2px solid var(--iron);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .pressure-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--brass), var(--danger));
            transition: width 0.5s;
        }

        .score-display {
            font-size: 1.2rem;
            color: var(--steam);
            text-shadow: 0 0 5px var(--brass);
        }

        /* Main Clock Display */
        .clock-stage {
            width: 220px;
            height: 220px;
            background: radial-gradient(circle, #e0e0e0 55%, #bdc3c7 65%);
            border-radius: 50%;
            border: 8px solid var(--bronze);
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Clock Markings */
        .clock-stage::before {
            content: "";
            position: absolute;
            width: 100%; height: 100%;
            background: repeating-conic-gradient(from 0deg, #333 0deg 1deg, transparent 1deg 30deg);
            border-radius: 50%;
        }

        .clock-number {
            position: absolute;
            width: 20px; height: 20px;
            text-align: center;
            line-height: 20px;
            font-weight: bold;
            color: #333;
            font-size: 1.2rem;
            font-family: 'Times New Roman', serif;
            z-index: 2;
        }

        .hand {
            position: absolute;
            bottom: 50%; left: 50%;
            transform-origin: bottom center;
            background: #333;
            border-radius: 5px;
            z-index: 5;
            transition: transform 0.5s cubic-bezier(0.4, 2.08, 0.55, 0.44);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        .hand.hour {
            width: 8px; height: 60px;
            background: var(--iron);
        }

        .hand.min {
            width: 4px; height: 85px;
            background: var(--danger);
        }

        .center-nut {
            width: 14px; height: 14px;
            background: var(--bronze);
            border-radius: 50%;
            position: absolute;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* Question Text */
        .readout-panel {
            background: #222;
            border: 2px solid var(--copper);
            color: var(--brass);
            padding: 15px;
            width: 100%;
            text-align: center;
            font-family: 'Courier New', Courier, monospace;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .main-query {
            font-size: 1.2rem;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .sub-query {
            font-size: 0.9rem;
            color: #888;
        }

        /* Gear Buttons */
        .gear-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
        }

        .gear-btn {
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23cd7f32' d='M50 0 L60 10 L70 0 L80 20 L90 10 L100 30 L90 40 L100 50 L90 60 L100 70 L90 80 L80 70 L70 90 L60 80 L50 100 L40 80 L30 90 L20 70 L10 80 L0 70 L10 60 L0 50 L10 40 L0 30 L10 20 L20 30 L30 10 L40 20 Z'/%3E%3Ccircle cx='50' cy='50' r='30' fill='%231a1a1d'/%3E%3C/svg%3E");
            background-size: cover;
            width: 100%;
            height: 120px;
            border: none;
            color: var(--steam);
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
            text-shadow: 0 2px 0 #000;
        }

        .gear-btn:hover {
            transform: rotate(15deg);
            filter: brightness(1.2);
        }

        .gear-btn:active {
            transform: scale(0.9);
        }

        .gear-btn.correct { filter: hue-rotate(90deg) brightness(1.5); } /* Greenish */
        .gear-btn.wrong { filter: hue-rotate(300deg) brightness(0.8); } /* Reddish */

        /* Overlays */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 15, 15, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: var(--brass);
            display: none;
        }
        .overlay.active { display: flex; }

        .start-btn {
            background: var(--bronze);
            color: #000;
            border: 2px solid var(--brass);
            padding: 20px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            text-transform: uppercase;
            box-shadow: 0 0 15px var(--bronze);
        }
        .start-btn:hover { background: var(--brass); }

        .steam-effect {
            position: absolute;
            width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 80%, white 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 50;
            transition: opacity 0.2s;
        }

        .audio-toggle {
            position: fixed;
            bottom: 20px; right: 20px;
            width: 50px; height: 50px;
            border: 2px solid var(--brass);
            border-radius: 50%;
            color: var(--brass);
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 200;
        }

    </style>
</head>
<body>

    <div class="gear-bg"></div>
    <div class="steam-effect" id="steam-overlay"></div>

    <div class="game-frame">
        
        <!-- Gauge Header -->
        <div class="gauge-panel">
            <div style="display:flex; flex-direction:column;">
                <span style="font-size:0.8rem; color:var(--danger)">PRESSURE</span>
                <div class="pressure-meter">
                    <div class="pressure-fill" id="pressure-bar"></div>
                </div>
            </div>
            <div class="score-display">REPAIRS: <span id="score">0</span></div>
        </div>

        <!-- Analog Clock Visual -->
        <div class="clock-stage" id="clock-visual">
            <div class="center-nut"></div>
            <div class="hand hour" id="hand-h"></div>
            <div class="hand min" id="hand-m"></div>
            <!-- Numbers injected by JS -->
        </div>

        <!-- Question Readout -->
        <div class="readout-panel">
            <div class="main-query" id="q-text">SYSTEM STABLE</div>
            <div class="sub-query" id="q-sub">Waiting to start...</div>
        </div>

        <!-- Gear Controls -->
        <div class="gear-grid" id="gear-box">
            <!-- Generated Buttons -->
        </div>

    </div>

    <div class="audio-toggle" id="audio-btn" onclick="toggleAudio()">â™ª</div>

    <!-- START SCREEN -->
    <div id="screen-start" class="overlay active">
        <h1 style="font-size: 3rem; text-shadow: 0 0 10px var(--brass);">THE CLOCKWORK<br>KEEPER</h1>
        <p style="max-width: 400px; line-height: 1.6;">
            The Great Clock is out of sync.<br>
            Solve the time equations to align the gears.<br>
            <strong>Warning:</strong> Wrong answers increase steam pressure!<br>
            Don't let the boiler explode.
        </p>
        <button class="start-btn" onclick="startGame()">START REPAIRS</button>
    </div>

    <!-- END SCREEN -->
    <div id="screen-end" class="overlay">
        <h1 style="color: var(--danger); font-size: 3rem;">CRITICAL FAILURE</h1>
        <p style="font-size: 1.5rem;">BOILER EXPLODED</p>
        <p style="margin-top: 20px; color: var(--steam);">Repairs Completed: <span id="final-score">0</span></p>
        <button class="start-btn" onclick="startGame()">RESTART ENGINE</button>
    </div>

    <script>
        /* --- AUDIO SYSTEM --- */
        const AudioSys = {
            ctx: null,
            on: true,
            init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play(type) {
                if(!this.on || !this.ctx) return;
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination);

                if (type === 'tick') { // Metallic Tick
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(2000, t);
                    gain.gain.setValueAtTime(0.05, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
                    osc.start(t); osc.stop(t + 0.05);
                } else if (type === 'gear') { // Ratchet
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, t);
                    osc.frequency.linearRampToValueAtTime(50, t + 0.1);
                    gain.gain.setValueAtTime(0.1, t);
                    gain.gain.linearRampToValueAtTime(0, t + 0.1);
                    osc.start(t); osc.stop(t + 0.1);
                } else if (type === 'steam') { // Hiss
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(50, t);
                    gain.gain.setValueAtTime(0.1, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                    osc.start(t); osc.stop(t + 0.5);
                } else if (type === 'alarm') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(800, t);
                    osc.frequency.setValueAtTime(600, t + 0.1);
                    gain.gain.setValueAtTime(0.1, t);
                    gain.gain.linearRampToValueAtTime(0, t + 0.4);
                    osc.start(t); osc.stop(t + 0.4);
                }
            }
        };

        function toggleAudio() {
            AudioSys.on = !AudioSys.on;
            document.getElementById('audio-btn').style.opacity = AudioSys.on ? '1' : '0.5';
            if(AudioSys.on) AudioSys.init();
        }

        /* --- GAME LOGIC --- */
        const state = {
            score: 0,
            pressure: 0, // 0 to 100
            locked: false,
            history: new Set(),
            currentAns: null
        };

        const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        function initClockFace() {
            const clock = document.getElementById('clock-visual');
            // Clear existing numbers if any (to prevent duplicates on restart if needed, though currently runs once)
            const existing = clock.querySelectorAll('.clock-number');
            existing.forEach(e => e.remove());

            for(let i=1; i<=12; i++) {
                const num = document.createElement('div');
                num.className = 'clock-number';
                num.textContent = i;
                // Radius logic: Clock is 220px, Radius 110.
                // Numbers should be inside, say at radius 90.
                // Angle: 1 is at 30deg, 12 at 0/360. 
                // Formula: x = r * sin(a), y = -r * cos(a) relative to center
                const angle = (i * 30) * (Math.PI / 180);
                const radius = 95; 
                const x = 110 + Math.sin(angle) * radius - 10; // -10 for centering element (width 20)
                const y = 110 - Math.cos(angle) * radius - 10;
                
                num.style.left = x + 'px';
                num.style.top = y + 'px';
                clock.appendChild(num);
            }
        }

        function startGame() {
            AudioSys.init();
            AudioSys.play('gear');
            initClockFace();
            state.score = 0;
            state.pressure = 0;
            state.history.clear();
            
            document.getElementById('screen-start').classList.remove('active');
            document.getElementById('screen-end').classList.remove('active');
            
            updateDisplay();
            nextPuzzle();
        }

        function updateDisplay() {
            document.getElementById('score').textContent = state.score;
            const pBar = document.getElementById('pressure-bar');
            pBar.style.width = state.pressure + '%';
            
            // Steam visual
            const steam = document.getElementById('steam-overlay');
            if(state.pressure > 70) steam.style.opacity = (state.pressure - 70) / 100;
            else steam.style.opacity = 0;
        }

        function nextPuzzle() {
            state.locked = false;
            generateUniqueQuestion();
        }

        function generateUniqueQuestion() {
            let unique = false;
            let attempts = 0;
            let qData;

            while(!unique && attempts < 50) {
                qData = createQuestion();
                if (!state.history.has(qData.id)) {
                    state.history.add(qData.id);
                    unique = true;
                }
                attempts++;
            }
            if (!unique) qData = createQuestion(); // Fallback
            
            renderQuestion(qData);
        }

        // Logic to set Clock Hands
        function setClock(h, m) {
            const hDeg = (h % 12) * 30 + (m / 60) * 30;
            const mDeg = m * 6;
            document.getElementById('hand-h').style.transform = `rotate(${hDeg}deg)`;
            document.getElementById('hand-m').style.transform = `rotate(${mDeg}deg)`;
        }

        function createQuestion() {
            const type = ['read', 'ops', 'convert', 'duration'][rand(0, 3)];
            let q = { id: '', text: '', sub: '', ans: '', opts: [], showClock: false };

            if (type === 'read') {
                // Read the clock
                const h = rand(1, 12);
                const m = rand(0, 11) * 5; // 5 min intervals
                q.ans = `${h}:${m.toString().padStart(2, '0')}`;
                q.text = "SYNC CHECK";
                q.sub = "What time is displayed?";
                q.showClock = true;
                q.h = h; q.m = m;
                // Ensure ID is fully unique for this specific time
                q.id = `read-${h}-${m}`;
                
                // Options
                let opts = new Set([q.ans]);
                // Distractors: swap hands, off by 5 mins, off by 1 hour
                opts.add(`${m/5 || 12}:${(h*5).toString().padStart(2,'0')}`); 
                opts.add(`${h}:${((m+5)%60).toString().padStart(2,'0')}`);
                opts.add(`${h+1 > 12 ? 1 : h+1}:${m.toString().padStart(2,'0')}`);
                
                while(opts.size < 4) opts.add(`${rand(1,12)}:${(rand(0,11)*5).toString().padStart(2,'0')}`);
                q.opts = Array.from(opts).slice(0,4);
            }
            else if (type === 'ops') {
                // Time arithmetic
                const h1 = rand(1, 5); const m1 = rand(1, 5) * 10;
                const h2 = rand(1, 3); const m2 = rand(1, 5) * 10;
                const isAdd = rand(0, 1);
                
                let totalMin, resH, resM;
                
                if (isAdd) {
                    totalMin = (h1*60 + m1) + (h2*60 + m2);
                    q.text = "GEAR ADDITION";
                    q.sub = `${h1}h ${m1}m + ${h2}h ${m2}m = ?`;
                } else {
                    // Ensure h1 > h2
                    let bh = Math.max(h1, h2) + 2; // Make minuend larger
                    totalMin = (bh*60 + m1) - (h2*60 + m2);
                    q.text = "GEAR SUBTRACTION";
                    q.sub = `${bh}h ${m1}m - ${h2}h ${m2}m = ?`;
                }
                
                resH = Math.floor(totalMin / 60);
                resM = totalMin % 60;
                q.ans = `${resH}h ${resM}m`;
                // ID includes operands to distinguish 1+2 from 0.5+2.5
                q.id = `ops-${isAdd}-${h1}h${m1}m-${h2}h${m2}m`;
                q.showClock = false;

                // Options
                let opts = new Set([q.ans]);
                opts.add(`${resH}h ${Math.abs(resM-10)}m`);
                opts.add(`${resH+1}h ${resM}m`);
                opts.add(`${resH}h ${resM+30 > 59 ? resM-30 : resM+30}m`);
                while(opts.size < 4) opts.add(`${rand(1,10)}h ${rand(0,5)*10}m`);
                q.opts = Array.from(opts).slice(0,4);
            }
            else if (type === 'convert') {
                // Conversions
                const mode = rand(0, 2); // 0: Week/Day, 1: Year/Month, 2: Day/Hour
                if (mode === 0) {
                    const w = rand(2, 8);
                    q.text = "CONVERSION";
                    q.sub = `${w} Weeks = ? Days`;
                    q.ans = (w * 7).toString();
                    q.opts = [(w*7).toString(), (w*5).toString(), (w*10).toString(), (w*7+2).toString()];
                } else if (mode === 1) {
                    const y = rand(2, 8);
                    q.text = "CONVERSION";
                    q.sub = `${y} Years = ? Months`;
                    q.ans = (y * 12).toString();
                    q.opts = [(y*12).toString(), (y*10).toString(), (y*12+6).toString(), (y*24).toString()];
                } else {
                    const d = rand(2, 5);
                    q.text = "CONVERSION";
                    q.sub = `${d} Days = ? Hours`;
                    q.ans = (d * 24).toString();
                    q.opts = [(d*24).toString(), (d*12).toString(), (d*20).toString(), (d*10).toString()];
                }
                q.id = `conv-${q.sub}`; // Unique based on question text
                q.showClock = false;
                q.opts = q.opts.sort(()=>Math.random()-0.5);
            }
            else if (type === 'duration') {
                // Simple duration
                const start = rand(1, 8);
                const dur = rand(1, 4);
                q.text = "CALCULATE END TIME";
                q.sub = `Start: ${start}:00. Duration: ${dur} hours.`;
                q.ans = `${start+dur}:00`;
                q.id = `dur-${start}-${dur}`;
                q.showClock = true;
                q.h = start; q.m = 0; // Show start time
                
                q.opts = [
                    `${start+dur}:00`,
                    `${start+dur+1}:00`,
                    `${start+dur-1}:00`,
                    `${start+dur}:30`
                ].sort(()=>Math.random()-0.5);
            }

            return q;
        }

        function renderQuestion(q) {
            state.currentAns = q.ans;
            document.getElementById('q-text').textContent = q.text;
            document.getElementById('q-sub').textContent = q.sub;

            const clockEl = document.getElementById('clock-visual');
            if (q.showClock) {
                clockEl.style.opacity = "1";
                setClock(q.h, q.m);
            } else {
                clockEl.style.opacity = "0.3";
                // Spin hands wildly to show "calculating" or just idle
                setClock(rand(1,12), rand(0,60));
            }

            const grid = document.getElementById('gear-box');
            grid.innerHTML = '';

            q.opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'gear-btn';
                btn.textContent = opt;
                btn.onclick = () => handleInput(opt, btn);
                grid.appendChild(btn);
            });
        }

        function handleInput(val, btn) {
            if(state.locked) return;
            state.locked = true;

            if(val === state.currentAns) {
                // Correct
                AudioSys.play('tick');
                btn.classList.add('correct');
                state.score++;
                // Reduce pressure on success
                state.pressure = Math.max(0, state.pressure - 10);
                updateDisplay();
                setTimeout(nextPuzzle, 1000);
            } else {
                // Wrong
                AudioSys.play('steam'); // Hiss
                btn.classList.add('wrong');
                state.pressure += 25; // Big penalty
                updateDisplay();
                
                if(state.pressure >= 100) {
                    AudioSys.play('alarm');
                    setTimeout(endGame, 1000);
                } else {
                    setTimeout(nextPuzzle, 1000);
                }
            }
        }

        function endGame() {
            document.getElementById('screen-end').classList.add('active');
            document.getElementById('final-score').textContent = state.score;
        }

    </script>
</body>
</html>