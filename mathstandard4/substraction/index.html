<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abyssal Math: Subtraction Descent</title>
    <style>
        :root {
            --deep-water: #001d3d;
            --mid-water: #003566;
            --teal-light: #4cc9f0;
            --alert: #ef233c;
            --sonar: #48cae4;
            --text-main: #caf0f8;
            --glass: rgba(255, 255, 255, 0.1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@500;700&display=swap');

        body {
            margin: 0;
            background-color: var(--deep-water);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
        }

        /* Ambient Background Animation */
        .ocean-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% -20%, var(--mid-water), var(--deep-water));
            z-index: -2;
        }

        .bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: floatUp 10s infinite linear;
            bottom: -50px;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: translateY(-110vh) scale(1.5); opacity: 0; }
        }

        /* Main Cockpit UI */
        .cockpit {
            width: 90%;
            max-width: 850px;
            background: rgba(0, 29, 61, 0.85);
            border: 2px solid var(--mid-water);
            border-radius: 30px;
            box-shadow: 0 0 50px rgba(76, 201, 240, 0.2), inset 0 0 100px rgba(0,0,0,0.5);
            padding: 2rem;
            position: relative;
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Porthole/Radar Ring */
        .radar-ring {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border-radius: 30px;
            pointer-events: none;
            overflow: hidden;
            z-index: -1;
        }
        
        .radar-sweep {
            position: absolute;
            top: 50%; left: 50%;
            width: 150%; height: 150%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(72, 202, 228, 0.1) 60deg, transparent 65deg);
            transform-origin: 0 0;
            animation: radarSpin 4s linear infinite;
        }

        @keyframes radarSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Headers */
        h1 {
            font-family: 'Share Tech Mono', monospace;
            color: var(--teal-light);
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 0 10px var(--teal-light);
            margin-top: 0;
        }

        /* Dashboard HUD */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            width: 100%;
            gap: 15px;
            margin-bottom: 2rem;
        }

        .meter {
            background: var(--glass);
            border: 1px solid var(--teal-light);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .meter-label { font-size: 0.8rem; color: var(--sonar); text-transform: uppercase; letter-spacing: 1px; }
        .meter-value { font-family: 'Share Tech Mono', monospace; font-size: 1.5rem; color: white; }

        /* Question Screen */
        .sonar-screen {
            background: #000;
            border: 2px solid #333;
            width: 100%;
            min-height: 180px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(76, 201, 240, 0.1);
        }

        .grid-lines {
            position: absolute;
            width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(76, 201, 240, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(76, 201, 240, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 0;
        }

        .question-content { z-index: 2; text-align: center; padding: 20px; }
        .equation { font-size: 2.5rem; font-family: 'Share Tech Mono', monospace; color: var(--teal-light); }
        .word-problem { font-size: 1.4rem; line-height: 1.5; color: #fff; max-width: 90%; }
        .topic-badge {
            background: var(--alert);
            color: white;
            padding: 4px 12px;
            font-size: 0.8rem;
            border-radius: 4px;
            margin-bottom: 10px;
            display: inline-block;
            font-family: 'Share Tech Mono', monospace;
        }

        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
        }

        .control-btn {
            background: rgba(0, 53, 102, 0.6);
            border: 1px solid var(--teal-light);
            color: var(--teal-light);
            padding: 15px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.4rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .control-btn:hover { background: var(--teal-light); color: var(--deep-water); box-shadow: 0 0 20px var(--teal-light); }
        .control-btn:active { transform: scale(0.98); }
        .correct-flash { background: #4caf50 !important; color: white !important; border-color: #4caf50 !important; }
        .wrong-flash { background: var(--alert) !important; color: white !important; border-color: var(--alert) !important; animation: shake 0.4s; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        /* Overlays */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 10, 20, 0.95);
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .hidden { display: none; }

        .start-btn {
            padding: 20px 50px;
            font-size: 1.5rem;
            background: transparent;
            color: var(--teal-light);
            border: 2px solid var(--teal-light);
            font-family: 'Share Tech Mono', monospace;
            cursor: pointer;
            border-radius: 5px;
            transition: 0.3s;
            box-shadow: 0 0 15px var(--teal-light);
        }
        .start-btn:hover { background: var(--teal-light); color: var(--deep-water); }

    </style>
</head>
<body>

    <div class="ocean-bg" id="ocean"></div>

    <div class="cockpit">
        <div class="radar-ring"><div class="radar-sweep"></div></div>
        
        <h1>Abyssal Subtractor</h1>

        <div class="dashboard">
            <div class="meter">
                <div class="meter-label">Current Depth</div>
                <div class="meter-value"><span id="score">0</span> m</div>
            </div>
            <div class="meter">
                <div class="meter-label">Zone Level</div>
                <div class="meter-value"><span id="level">1</span></div>
            </div>
            <div class="meter">
                <div class="meter-label">Hull Integrity</div>
                <div class="meter-value" style="color: var(--alert);"><span id="lives">100</span>%</div>
            </div>
        </div>

        <div class="sonar-screen">
            <div class="grid-lines"></div>
            <div class="question-content">
                <div id="topic-badge" class="topic-badge">SCANNING...</div>
                <div id="question-text" class="equation">Initializing System</div>
            </div>
        </div>

        <div class="controls" id="options-area">
            </div>

        <div id="start-screen" class="overlay">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">OPERATION DEEP DIVE</h1>
            <p style="color: #aaa; margin-bottom: 30px;">
                Mission: Solve subtraction problems to increase diving depth.<br>
                Modules: Consecutive, Unknowns, Word Problems.
            </p>
            <button class="start-btn" onclick="initMission()">INITIATE DIVE</button>
        </div>

        <div id="game-over" class="overlay hidden">
            <h1 style="color: var(--alert);">HULL BREACHED</h1>
            <p style="font-size: 1.5rem;">Max Depth Reached: <span id="final-depth">0</span> m</p>
            <button class="start-btn" onclick="initMission()">REBOOT SYSTEMS</button>
        </div>
    </div>

<script>
    // --- BUBBLE ANIMATION ---
    const ocean = document.getElementById('ocean');
    function createBubbles() {
        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        const size = Math.random() * 20 + 5;
        bubble.style.width = `${size}px`;
        bubble.style.height = `${size}px`;
        bubble.style.left = `${Math.random() * 100}%`;
        bubble.style.animationDuration = `${Math.random() * 5 + 5}s`;
        ocean.appendChild(bubble);
        setTimeout(() => bubble.remove(), 10000);
    }
    setInterval(createBubbles, 500);

    // --- AUDIO SYSTEM (Synthesized) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const now = audioCtx.currentTime;

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'sonar') {
            // High ping sound
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, now);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 1);
            osc.start();
            osc.stop(now + 1);
        } else if (type === 'correct') {
            // Digital chime
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.linearRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start();
            osc.stop(now + 0.3);
        } else if (type === 'wrong') {
            // Low error buzz
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.3);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start();
            osc.stop(now + 0.3);
        }
    }

    // --- GAME LOGIC ---
    let state = {
        depth: 0,
        level: 1,
        hull: 100,
        active: false
    };

    function initMission() {
        state = { depth: 0, level: 1, hull: 100, active: true };
        updateDisplay();
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over').classList.add('hidden');
        playSound('sonar');
        nextProblem();
    }

    function updateDisplay() {
        document.getElementById('score').innerText = state.depth;
        document.getElementById('level').innerText = state.level;
        document.getElementById('lives').innerText = state.hull;
    }

    function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function fmt(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

    // --- QUESTION GENERATORS ---

    // 1. Standard Subtraction
    function getStandard() {
        let max = Math.pow(10, Math.min(state.level + 2, 6)); // Scales up
        let a = rand(max * 0.1, max);
        let b = rand(1, a);
        return {
            topic: "SUBTRACTION",
            text: `<span class="equation">${fmt(a)} - ${fmt(b)} = ?</span>`,
            correct: a - b
        };
    }

    // 2. Consecutive Subtraction (A - B - C)
    function getConsecutive() {
        let max = Math.pow(10, Math.min(state.level + 2, 5));
        let a = rand(max * 0.2, max);
        let b = rand(1, a / 2);
        let c = rand(1, (a - b) / 2);
        
        return {
            topic: "CONSECUTIVE SUBTRACT",
            text: `<span class="equation" style="font-size: 2rem">${fmt(a)} - ${fmt(b)} - ${fmt(c)} = ?</span>`,
            correct: a - b - c
        };
    }

    // 3. Unknown in Subtraction (Algebraic)
    function getUnknown() {
        let max = Math.pow(10, Math.min(state.level + 2, 5));
        let a = rand(max * 0.2, max);
        let b = rand(1, a - 1);
        let c = a - b;

        // Either "a - ? = c" or "? - b = c"
        let type = Math.random() > 0.5;
        let text = type 
            ? `${fmt(a)} - <span style="color:var(--alert)">?</span> = ${fmt(c)}`
            : `<span style="color:var(--alert)">?</span> - ${fmt(b)} = ${fmt(c)}`;
        
        return {
            topic: "FIND UNKNOWN",
            text: `<span class="equation">${text}</span>`,
            correct: type ? b : a
        };
    }

    // 4. Word Problems
    function getWordProblem() {
        let max = 500 * state.level;
        let a = rand(max/2, max);
        let b = rand(10, a/2);
        let ans = a - b;

        const scenarios = [
            `Submarine Alpha is at <b>${fmt(a)}m</b>. It rises <b>${fmt(b)}m</b> towards the surface. What is the new depth?`,
            `We have <b>${fmt(a)}</b> units of oxygen. The crew consumes <b>${fmt(b)}</b> units. How much is left?`,
            `The radar detects <b>${fmt(a)}</b> fish. A shark scares away <b>${fmt(b)}</b> of them. How many remain?`,
            `Treasure chest contained <b>${fmt(a)}</b> gold coins. We took <b>${fmt(b)}</b> coins. How many are left in the chest?`
        ];

        return {
            topic: "DATA ANALYSIS",
            text: `<div class="word-problem">${scenarios[rand(0, scenarios.length-1)]}</div>`,
            correct: ans
        };
    }

    function nextProblem() {
        if (!state.active) return;

        // Difficulty / Topic Rotation
        let typeRoll = Math.random();
        let q;
        
        // Logic: Introduce harder topics as levels increase
        if (state.level === 1) {
            q = getStandard();
        } else if (state.level === 2) {
            q = typeRoll > 0.5 ? getStandard() : getConsecutive();
        } else {
            if (typeRoll < 0.3) q = getStandard();
            else if (typeRoll < 0.6) q = getConsecutive();
            else if (typeRoll < 0.8) q = getUnknown();
            else q = getWordProblem();
        }

        render(q);
    }

    function render(data) {
        document.getElementById('topic-badge').innerText = data.topic;
        document.getElementById('question-text').innerHTML = data.text;

        // Generate Answers
        let answers = [data.correct];
        while (answers.length < 4) {
            // Smart distractors based on common subtraction errors
            let offset = rand(1, 10) * Math.pow(10, rand(0, 2));
            let fake = Math.random() > 0.5 ? data.correct + offset : data.correct - offset;
            if (fake >= 0 && !answers.includes(fake)) answers.push(fake);
        }
        
        // Shuffle
        answers.sort(() => Math.random() - 0.5);

        const area = document.getElementById('options-area');
        area.innerHTML = '';
        answers.forEach(ans => {
            let btn = document.createElement('button');
            btn.className = 'control-btn';
            btn.innerText = fmt(ans);
            btn.onclick = () => check(btn, ans, data.correct);
            area.appendChild(btn);
        });
    }

    function check(btn, val, correct) {
        if (!state.active) return;

        // Lock buttons
        const allBtns = document.querySelectorAll('.control-btn');
        allBtns.forEach(b => b.disabled = true);

        if (val === correct) {
            // Correct
            btn.classList.add('correct-flash');
            playSound('correct');
            state.depth += 50 * state.level;
            
            if (state.depth > state.level * 500) {
                state.level++;
                playSound('sonar'); // Level up sound
            }
            updateDisplay();
            setTimeout(nextProblem, 1000);
        } else {
            // Wrong
            btn.classList.add('wrong-flash');
            playSound('wrong');
            state.hull -= 25; // 4 hits -> Game Over
            updateDisplay();
            
            // Show correct answer
            allBtns.forEach(b => {
                if (parseInt(b.innerText.replace(/,/g, '')) === correct) {
                    b.classList.add('correct-flash');
                }
            });

            if (state.hull <= 0) {
                setTimeout(gameOver, 1000);
            } else {
                setTimeout(nextProblem, 1500);
            }
        }
    }

    function gameOver() {
        state.active = false;
        document.getElementById('final-depth').innerText = fmt(state.depth);
        document.getElementById('game-over').classList.remove('hidden');
        playSound('wrong');
    }

</script>
</body>
</html>