<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Wealthy Merchant</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #85c1e9;
            font-family: 'Nunito', sans-serif;
            touch-action: none;
            user-select: none;
        }

        /* --- LAYOUT --- */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Background Shop */
        #shop-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%; /* Top 60% is visual */
            background: linear-gradient(to bottom, #fdf2e9 0%, #e8daef 100%);
            z-index: 1;
        }
        
        #counter {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40px;
            background: #8e44ad;
            border-top: 10px solid #5b2c6f;
        }

        /* The Customer */
        #customer-container {
            position: absolute;
            bottom: 20px; /* Sitting on counter */
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 300px;
            z-index: 2;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* Simple CSS Character */
        .char-body {
            width: 120px;
            height: 140px;
            background: #f1c40f;
            border-radius: 50px 50px 0 0;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .char-head {
            width: 100px;
            height: 100px;
            background: #f39c12;
            border-radius: 50%;
            position: absolute;
            top: -60px;
            left: 10px;
        }
        .char-eyes {
            position: absolute;
            top: 35px;
            left: 25px;
            width: 10px;
            height: 10px;
            background: #333;
            border-radius: 50%;
            box-shadow: 40px 0 0 #333;
        }

        /* Speech Bubble (The Question) */
        #speech-bubble {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 5;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            border: 4px solid #333;
        }

        #speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 20px 20px 0;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        #speech-bubble::before { /* Inner triangle for border effect */
            content: '';
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 17px 17px 0;
            border-style: solid;
            border-color: white transparent transparent transparent;
            z-index: 1;
        }

        #q-topic {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        #q-text {
            font-size: 24px;
            color: #2c3e50;
            font-weight: 700;
            margin: 0;
            line-height: 1.4;
        }

        /* --- INTERFACE (Bottom Half) --- */
        #interface-layer {
            position: absolute;
            top: 60%; /* Start below the shop visual */
            width: 100%;
            height: 40%;
            background: #2c3e50;
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }

        #register-screen {
            background: #ecf0f1;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 20px;
            color: #27ae60;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
        }

        #options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: 100%;
        }

        .option-btn {
            background: #34495e;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-family: 'Nunito', sans-serif;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #2c3e50;
            transition: transform 0.1s, background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            text-align: center;
        }

        .option-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        
        .option-btn:hover {
            background: #46637f;
        }

        /* --- OVERLAYS --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 62, 80, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 48px;
            color: #f1c40f;
            text-shadow: 4px 4px 0 #e67e22;
            margin-bottom: 10px;
        }

        .btn-start {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 24px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 50px;
            font-family: 'Fredoka One', cursive;
            cursor: pointer;
            box-shadow: 0 6px 0 #1e8449;
            transition: transform 0.1s;
        }
        .btn-start:active { transform: translateY(6px); box-shadow: none; }

        .hidden { display: none !important; }

        /* Floating Money Animation */
        .floater {
            position: absolute;
            font-weight: bold;
            font-size: 24px;
            animation: floatUp 1s forwards;
            pointer-events: none;
            z-index: 20;
        }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }

        #hud-money {
            color: #27ae60;
        }

    </style>
</head>
<body>

<div id="game-container">
    
    <div id="shop-bg">
        <div id="counter"></div>
    </div>

    <div id="customer-container">
        <div class="char-body">
            <div class="char-head">
                <div class="char-eyes"></div>
            </div>
        </div>
    </div>

    <div id="speech-bubble">
        <div id="q-topic">TOPIC</div>
        <div id="q-text">Hello!</div>
    </div>

    <div id="interface-layer">
        <div id="register-screen">
            <span>TOTAL:</span>
            <span id="hud-money">RM 0.00</span>
        </div>
        <div id="options-grid">
            </div>
    </div>

    <div id="start-screen" class="screen">
        <h1>THE WEALTHY<br>MERCHANT</h1>
        <p style="font-size: 18px; max-width: 500px; line-height: 1.6;">
            Master the art of Money!<br>
            Calculate Profits, Discounts, and Dividends.<br>
            <br>
            <strong>No Timer. Take your time.</strong>
        </p>
        <button class="btn-start" onclick="Game.start()">OPEN SHOP</button>
    </div>

</div>

<script>
/* --- AUDIO SYSTEM --- */
const AudioSys = {
    ctx: null,
    init() {
        if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    },
    playTone(freq, type, duration, vol=0.1) {
        if(!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    playCash() { // Cha-ching!
        if(!this.ctx) return;
        this.playTone(1200, 'square', 0.1, 0.1);
        setTimeout(() => this.playTone(1800, 'square', 0.3, 0.1), 100);
    },
    playWrong() { // Buzzer
        if(!this.ctx) return;
        this.playTone(150, 'sawtooth', 0.3, 0.2);
    },
    playPop() { // Bubble pop
        if(!this.ctx) return;
        this.playTone(600, 'sine', 0.05, 0.1);
    }
};

/* --- MATH LOGIC (Chapter 3: Money) --- */
const MathEngine = {
    generate(level) {
        // Topics based on provided images
        const modes = ['asset_liability', 'profit_loss', 'discount', 'service_tax', 'dividend'];
        // Pick random mode
        const mode = modes[Math.floor(Math.random() * modes.length)];
        
        let q, a, wrongs = [];
        let topic = "";

        switch(mode) {
            case 'asset_liability': //
                topic = "ASSETS & LIABILITIES";
                const items = [
                    { name: "Car Loan", type: "Liability" },
                    { name: "Credit Card Debt", type: "Liability" },
                    { name: "Cash in Hand", type: "Asset" },
                    { name: "House", type: "Asset" },
                    { name: "Investments", type: "Asset" },
                    { name: "Rental Owing", type: "Liability" }
                ];
                const item = items[Math.floor(Math.random() * items.length)];
                q = `Is "${item.name}" an Asset or a Liability?`;
                a = item.type;
                wrongs = [(item.type === "Asset" ? "Liability" : "Asset")];
                // Fill dummy slots for 4 buttons
                wrongs.push("Income", "Expense");
                break;

            case 'profit_loss': //
                topic = "PROFIT & LOSS";
                const cp = Math.floor(Math.random() * 50) + 10;
                // Decide if profit or loss
                if (Math.random() > 0.5) {
                    // Profit
                    const profit = Math.floor(Math.random() * 20) + 5;
                    const sp = cp + profit;
                    q = `Cost Price: RM ${cp}<br>Selling Price: RM ${sp}<br>What is the Profit?`;
                    a = `RM ${profit}`;
                    wrongs = [`RM ${profit+10}`, `RM ${profit-2}`, `RM ${cp}`];
                } else {
                    // Loss
                    const loss = Math.floor(Math.random() * 10) + 1;
                    const sp = cp - loss;
                    q = `Cost Price: RM ${cp}<br>Selling Price: RM ${sp}<br>What is the Loss?`;
                    a = `RM ${loss}`;
                    wrongs = [`RM ${loss+5}`, `RM ${cp}`, `RM ${sp}`];
                }
                break;

            case 'discount': //
                topic = "DISCOUNTS & VOUCHERS";
                const price = Math.floor(Math.random() * 10) * 100; // 100, 200...
                const discPercent = [10, 20, 25, 50][Math.floor(Math.random()*4)];
                q = `Item Price: RM ${price}<br>I have a ${discPercent}% Discount Voucher.<br>How much do I pay?`;
                const finalP = price * ((100-discPercent)/100);
                a = `RM ${finalP}`;
                wrongs = [`RM ${price - discPercent}`, `RM ${price/2}`, `RM ${finalP + 20}`];
                break;

            case 'service_tax': //
                topic = "BILLS & TAX";
                const bill = Math.floor(Math.random() * 20) * 10; // 10, 20... 200
                const tax = 6; // Standard Service Tax example
                q = `Dinner Bill: RM ${bill}<br>Service Tax is ${tax}%.<br>What is the tax amount?`;
                const taxAmt = (bill * tax) / 100;
                a = `RM ${taxAmt.toFixed(2)}`;
                wrongs = [`RM ${(taxAmt+1).toFixed(2)}`, `RM 6.00`, `RM ${bill.toFixed(2)}`];
                break;

            case 'dividend': //
                topic = "INVESTMENT";
                const invest = [1000, 5000, 10000][Math.floor(Math.random()*3)];
                const divRate = Math.floor(Math.random() * 5) + 3; // 3-8%
                q = `Invested RM ${invest}.<br>Dividend rate is ${divRate}%.<br>Calculate the Dividend.`;
                const divVal = (invest * divRate) / 100;
                a = `RM ${divVal}`;
                wrongs = [`RM ${divVal * 10}`, `RM ${divVal/2}`, `RM ${divRate}`];
                break;
        }

        return { q, a, wrongs, topic };
    }
};

/* --- GAME ENGINE --- */
const Game = {
    money: 0,
    currentData: null,
    
    start() {
        AudioSys.init();
        document.getElementById('start-screen').classList.add('hidden');
        this.money = 0;
        this.updateMoneyDisplay();
        this.nextCustomer();
    },

    nextCustomer() {
        // Animation: Reset
        const char = document.getElementById('customer-container');
        const bubble = document.getElementById('speech-bubble');
        
        // 1. Hide bubble
        bubble.style.opacity = 0;
        bubble.style.transform = "translateX(-50%) scale(0.8)";
        
        // 2. Move customer out (down)
        char.style.transform = "translateX(-50%) translateY(200px)";

        setTimeout(() => {
            // 3. Change Customer Color (Randomize look)
            const hue = Math.random() * 360;
            document.querySelector('.char-body').style.filter = `hue-rotate(${hue}deg)`;
            
            // 4. Generate Question
            this.currentData = MathEngine.generate(1);
            document.getElementById('q-topic').innerText = this.currentData.topic;
            document.getElementById('q-text').innerHTML = this.currentData.q;
            this.generateButtons(this.currentData);

            // 5. Bring Customer In
            AudioSys.playPop();
            char.style.transform = "translateX(-50%) translateY(0)";
            
            setTimeout(() => {
                // 6. Show Bubble
                bubble.style.opacity = 1;
                bubble.style.transform = "translateX(-50%) scale(1)";
            }, 300);

        }, 500);
    },

    generateButtons(data) {
        const grid = document.getElementById('options-grid');
        grid.innerHTML = '';
        
        let options = [data.a, ...data.wrongs];
        // Ensure only 4 options maximum
        options = options.slice(0, 4);
        // Shuffle
        options.sort(() => Math.random() - 0.5);

        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => this.checkAnswer(opt, data.a);
            grid.appendChild(btn);
        });
    },

    checkAnswer(selected, correct) {
        if (selected === correct) {
            // Correct
            AudioSys.playCash();
            this.money += 50;
            this.updateMoneyDisplay();
            this.showFloater("+ RM 50", "#27ae60");
            
            // Success animation
            document.getElementById('speech-bubble').style.backgroundColor = "#d4efdf";
            setTimeout(() => {
                 document.getElementById('speech-bubble').style.backgroundColor = "white";
                 this.nextCustomer();
            }, 1000);

        } else {
            // Wrong
            AudioSys.playWrong();
            this.showFloater("Try Again!", "#e74c3c");
            
            // Shake effect
            const bubble = document.getElementById('speech-bubble');
            bubble.style.transform = "translateX(-50%) rotate(5deg)";
            setTimeout(() => bubble.style.transform = "translateX(-50%) rotate(-5deg)", 100);
            setTimeout(() => bubble.style.transform = "translateX(-50%) rotate(0deg)", 200);
        }
    },

    updateMoneyDisplay() {
        document.getElementById('hud-money').innerText = `RM ${this.money.toFixed(2)}`;
    },

    showFloater(text, color) {
        const el = document.createElement('div');
        el.className = 'floater';
        el.innerText = text;
        el.style.color = color;
        el.style.left = '50%';
        el.style.top = '40%';
        el.style.transform = 'translateX(-50%)';
        document.getElementById('game-container').appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }
};

</script>
</body>
</html>